parameters:
  variables: {}
  osGroup: ''
  archType: ''
  container: ''
  pool: {}
  isOfficialBuild: false
  runTests: true

jobs:

- template: /eng/common/templates/jobs/jobs.yml
  parameters:
    enableTelemetry: true
    helixRepo: dotnet/msquic
    pool: ${{ parameters.pool }}
    enablePublishBuildArtifacts: true
    enablePublishBuildAssets: ${{ eq(parameters.osGroup, 'Windows') }}
    enablePublishUsingPipelines: true
    enableMicrobuild: true
    graphFileGeneration:
      enabled: false
      includeToolset: false

    jobs:
    - job: ${{ format('{0}_{1}', parameters.osGroup, parameters.archType) }}
      displayName: ${{ format('{0} {1}', parameters.osGroup, parameters.archType) }}
      strategy:
        matrix:
          Release:
            _BuildConfig: Release
          ${{ if eq(parameters.isOfficialBuild, false) }}:
            Debug:
              _BuildConfig: Debug

      ${{ if eq(parameters.runTests, true) }}:
        testResultsFormat: vstest
        testRunTitle: ${{ parameters.osGroup }}_${{ parameters.archType }}_$(_BuildConfig)

      ${{ if ne(parameters.container, '') }}:
        ${{ if eq(parameters.container.registry, 'mcr') }}:
          container: ${{ format('{0}:{1}', 'mcr.microsoft.com/dotnet-buildtools/prereqs', parameters.container.image) }}
        ${{ if ne(parameters.container.registry, 'mcr') }}:
          container: ${{ format('{0}:{1}', parameters.container.registry, parameters.container.image) }}

      variables:
        - _buildScript: build.cmd

        - ${{ if ne(parameters.osGroup, 'Windows') }}:
          - _buildScript: ./build.sh
          - _outputPath: $(Build.SourcesDirectory)/artifacts/packages/${{ parameters.osGroup }}/${{ parameters.archType }}_$(_BuildConfig)_openssl

        - ${{ if eq(parameters.osGroup, 'macOS') }}:
          - OPENSSL_ROOT_DIR: /usr/local/opt/openssl@1.1

        - _testBuildArg: ''
        - _docker: ''
        - ${{ if eq(parameters.runTests, true) }}:
          - _testBuildArg: -test

        - _officialBuildArgs: ''
        - _signingArgs: ''
        - ${{ if eq(parameters.isOfficialBuild, true) }}:
          - group: DotNet-Symbol-Server-Pats
          - _SignType: real
          - _officialBuildArgs: -publish
                                /p:TeamName=$(_TeamName)
                                /p:OfficialBuildId=$(Build.BuildNumber)
                                /p:DotNetPublishUsingPipelines=true
                                /p:DotNetSymbolServerTokenMsdl=$(microsoft-symbol-server-pat)
                                /p:DotNetSymbolServerTokenSymWeb=$(symweb-symbol-server-pat)
          - ${{ if eq(parameters.osGroup, 'Windows') }}:
            - _signingArgs: -sign
                            /p:DotNetSignType=$(_SignType)
        - _buildargs: -ci -c $(_BuildConfig) $(_testBuildArg) $(_signingArgs) $(_officialBuildArgs) /p:TargetArchitecture=${{ parameters.archType }}
        - ${{ if eq(parameters.archType, 'arm64') }}:
          - _buildScript: docker run --platform linux/arm64 --volume $BUILD_REPOSITORY_LOCALPATH:/msquic -t mcr.microsoft.com/dotnet-buildtools/prereqs:ubuntu-18.04-arm64v8-20220803130954-bfcd90a bash -c "apt-get update && apt-get install -y wget curl && curl -L -o /tmp/pwsh.tgz https://github.com/PowerShell/PowerShell/releases/download/v7.2.5/powershell-7.2.5-linux-arm64.tar.gz && tar xfz /tmp/pwsh.tgz -C /usr/local/bin/ && curl -o /tmp/cmake.tgz  https://cmake.org/files/v3.23/cmake-3.23.1-linux-aarch64.tar.gz && tar xfz /tmp/cmake.tgz --strip 1  -C /usr/local/ && /msquic/build.sh $(_buildargs)" && echo

      steps:
      - checkout: self
        submodules: recursive

      - ${{ if eq(parameters.archType, 'arm64') }}:
        - script: sudo apt-get update && sudo apt-get install -y qemu binfmt-support qemu-user-static docker ruby-dev
        - script: docker run --rm --privileged multiarch/qemu-user-static --reset -p yes 
          displayName: Setup QEMU

      - ${{ if eq(parameters.osGroup, 'Windows') }}:
        - script: $(Build.SourcesDirectory)\eng\common\init-tools-native.cmd -InstallDirectory $(Build.SourcesDirectory)\native-tools -Force
          displayName: Install native dependencies

      - ${{ if or(eq(parameters.osGroup, 'macOS'), eq(parameters.archType, 'arm64')) }}:
        # use cmake from Brew (that may be different)
        - script:  sed -i.ORI '/cmake/d'  global.json
          displayName: Remove cmake for macOS
        - script: sudo gem install fpm
          displayName: Install fpm

      - script: $(_buildScript) $(_buildargs)
        displayName: Build binaries

      - ${{ if ne(parameters.osGroup, 'Windows') }}:
        - script: ./scripts/make-packages.sh -arch ${{ parameters.archType }} -output $(_outputPath)
          displayName: Make Unix packages
          workingDirectory: src/msquic

        - task: PublishBuildArtifacts@1
          displayName: Push Unix Packages
          inputs:
            PathtoPublish: $(_outputPath)
            PublishLocation: Container
            ArtifactName: UnsignedUnixPackages
          condition: succeeded()
